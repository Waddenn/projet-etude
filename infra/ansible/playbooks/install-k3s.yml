---
# ─────────────────────────────────────────────────────────────────
# Install K3s cluster (server + agents)
# Prerequisites should be installed by prepare-lxc-k3s.yml first
#
# Usage:
#   ansible-playbook -i inventory/dev.yml playbooks/install-k3s.yml
# ─────────────────────────────────────────────────────────────────

- name: Ensure LXC prerequisites (idempotent)
  hosts: k3s_server:k3s_agents
  vars_files:
    - "{{ playbook_dir }}/../group_vars/all.yml"
  tasks:
    - name: Verify /dev/kmsg exists
      stat:
        path: /dev/kmsg
      register: kmsg_check

    - name: Create /dev/kmsg if missing
      file:
        src: /dev/console
        dest: /dev/kmsg
        state: link
        force: true
      when: not kmsg_check.stat.exists

    - name: Install prerequisites
      apt:
        name:
          - curl
          - ca-certificates
          - open-iscsi
          - apparmor
          - iptables
        state: present
        update_cache: true

- name: Install K3s server
  hosts: k3s_server
  vars_files:
    - "{{ playbook_dir }}/../group_vars/all.yml"
  tasks:
    - name: Install K3s server
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION={{ k3s_version }} sh -s - server \
          --write-kubeconfig-mode 644 \
          --tls-san {{ ansible_host }} \
          --node-ip {{ ansible_host }} \
          --flannel-iface eth0
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for K3s to be ready
      command: k3s kubectl get nodes
      register: result
      until: result.rc == 0
      retries: 30
      delay: 10

    - name: Get node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token

    - name: Store token as fact
      set_fact:
        k3s_token: "{{ node_token.content | b64decode | trim }}"

    - name: Get kubeconfig
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ playbook_dir }}/../kubeconfig.yaml"
        flat: true

    - name: Fix kubeconfig server address
      local_action:
        module: replace
        path: "{{ playbook_dir }}/../kubeconfig.yaml"
        regexp: 'https://127.0.0.1:6443'
        replace: "https://{{ ansible_host }}:6443"

- name: Install K3s agents
  hosts: k3s_agents
  vars_files:
    - "{{ playbook_dir }}/../group_vars/all.yml"
  tasks:
    - name: Install K3s agent
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION={{ k3s_version }} sh -s - agent \
          --server https://{{ hostvars[groups['k3s_server'][0]]['ansible_host'] }}:6443 \
          --token {{ hostvars[groups['k3s_server'][0]]['k3s_token'] }} \
          --node-ip {{ ansible_host }} \
          --flannel-iface eth0
      args:
        creates: /usr/local/bin/k3s-agent

    - name: Wait for agent to join
      delegate_to: "{{ groups['k3s_server'][0] }}"
      shell: k3s kubectl get nodes | grep {{ inventory_hostname }}
      register: agent_joined
      until: agent_joined.rc == 0
      retries: 30
      delay: 10
