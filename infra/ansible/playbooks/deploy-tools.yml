---
- name: Deploy DevOps tools on K3s cluster
  hosts: k3s_server
  become: true
  tasks:
    - name: Install Helm
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Add Helm repos
      command: "helm repo add {{ item.name }} {{ item.url }}"
      loop:
        - { name: prometheus-community, url: "https://prometheus-community.github.io/helm-charts" }
        - { name: grafana, url: "https://grafana.github.io/helm-charts" }
        - { name: hashicorp, url: "https://helm.releases.hashicorp.com" }

    - name: Update Helm repos
      command: helm repo update

    - name: Create namespaces
      command: "kubectl create namespace {{ item }} --dry-run=client -o yaml | kubectl apply -f -"
      loop:
        - devboard-dev
        - devboard-staging
        - devboard-prod
        - monitoring
        - security

    - name: Install kube-prometheus-stack
      command: >
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack
        --namespace monitoring
        --set grafana.adminPassword=admin
        --wait

    - name: Install Loki stack
      command: >
        helm upgrade --install loki grafana/loki-stack
        --namespace monitoring
        --set promtail.enabled=true
        --set loki.persistence.enabled=true
        --wait

    - name: Install Vault
      command: >
        helm upgrade --install vault hashicorp/vault
        --namespace security
        --set server.dev.enabled=true
        --wait
