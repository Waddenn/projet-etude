apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: devboard-alerts
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
    - name: devboard.rules
      rules:
        - alert: HighErrorRate
          expr: |
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m])) > 0.05
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "High error rate detected"
            description: "Error rate is above 5% for more than 2 minutes"

        - alert: HighLatency
          expr: |
            histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High latency detected"
            description: "P95 latency is above 1s for more than 5 minutes"

        - alert: PodCrashLooping
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace=~"devboard-.*"}[5m]) * 300 > 3
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod is crash looping"
            description: "Pod {{ $labels.pod }} is restarting frequently"

        - alert: DeploymentReplicasMismatch
          expr: |
            kube_deployment_spec_replicas{namespace=~"devboard-.*"}
            != kube_deployment_status_ready_replicas{namespace=~"devboard-.*"}
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Deployment replicas mismatch"
            description: "Deployment {{ $labels.deployment }} has mismatched replicas"

        - alert: HighCPUUsage
          expr: |
            sum by (namespace) (rate(container_cpu_usage_seconds_total{namespace=~"devboard-.*"}[5m]))
            /
            sum by (namespace) (kube_pod_container_resource_requests{namespace=~"devboard-.*", resource="cpu"}) > 0.85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage in namespace"
            description: "CPU usage in {{ $labels.namespace }} is above 85%"
