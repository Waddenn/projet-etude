name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: azure/setup-kubectl@v3
      - name: Set kubeconfig
        run: echo "${{ secrets.KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
      - name: Rollback
        env:
          KUBECONFIG: /tmp/kubeconfig
          NS: devboard-${{ github.event.inputs.environment == 'production' && 'prod' || github.event.inputs.environment }}
        run: |
          echo "Rolling back deployments in namespace $NS..."
          kubectl rollout undo deployment/backend -n $NS
          kubectl rollout undo deployment/frontend -n $NS
          kubectl rollout status deployment/backend -n $NS --timeout=120s
          kubectl rollout status deployment/frontend -n $NS --timeout=120s
          echo "Rollback complete."
